#!/bin/bash

if ! which jq &>/dev/null; then
  echo "You need to download jq to use this script"
  exit 1
fi

case "$(uname -s)" in
Darwin)
  STORAGE_FILE="${HOME}/Library/Application Support/Microsoft/Teams/storage.json"
  ;;
Linux)
  STORAGE_FILE="${HOME}/.config/Microsoft/Microsoft Teams/storage.json"
  ;;
CYGWIN*|MINGW32*|MSYS*|MINGW*)
  echo "Windows OS not supported. Try https://github.com/EBOOZ/TeamsStatus."
  exit 1
  ;;
*)
  echo "OS not supported."
  exit 1
  ;;
esac

current_state="$(jq -r '.appStates.states' <"$STORAGE_FILE" | sed 's/.*,//')"
current_status="$(jq -r '.activityEvents.events | last' <"$STORAGE_FILE")"

case "${current_state}${current_status}" in
*incoming_call*)
#  echo "call incoming"
  exit 2
  ;;
*InCall*|*call_accept*)
#  echo "☎️ In a call"
  exit 0
  ;;
*CallEnded*|*calling_call_disconnected*)
  # echo "not in call"
  exit 1
  ;;
esac
